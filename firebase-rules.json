{
  "rules": {
    ".read": true,
    ".write": false,
    "status" : {
      "$user_id" : { 
        ".write" : "auth.id == $userId"
      }
    },
    "auction" : {
      ".write" : true
    },
    "chat" : {
        ".read": false,
        ".write": false,
        "channels" : {
            ".read": true,
            "$channelId" : { 
                // Append-only by anyone, and admins can add official channels, and edit or remove channels as well.
                ".write": "(auth != null) && (!data.exists() || root.child('chat').child('users').child(auth.id).child('isModerator').val() == true || data.child('createdByUserId').val() === auth.id)",
                ".validate": "newData.hasChildren(['name','type'])",
                "id": {
                  ".validate": "(newData.val() === $channelId)"
                },
                "createdByUserId": {
                  ".validate": "(auth.id === newData.val())"
                },
                "type": {
                  ".validate": "('public' === newData.val()) || 'private' === newData.val() || ('official' === newData.val() && (root.child('chat').child('users').child(auth.id).child('isModerator').val())"
                },
                // A list of users that may read messages from this channel.
                "authorizedUsers": {
                  ".write": "(auth != null) && (!data.exists() || root.child('chat').child('users').child(auth.id).child('isModerator').val() == true || data.hasChild(auth.id))"
                },
                "messages" : {   // A list of messages in this channel, viewable by anyone for public channels, or authorized users for private channels.
                    ".read": "(root.child('chat').child('channels').child($channelId).child('type').val() != 'private' || root.child('chat').child('channels').child($channelId).child('authorizedUsers').hasChild(auth.id))",
                        "$messageId": {
                          // Allow anyone to append to this list and allow admins to edit or remove.
                          ".write": "(auth != null) && (data.val() === null || root.child('chat').child('users').child(auth.id).child('isModerator').val() == true && (root.child('chat').child('channels').child($channelId).child('type').val() != 'private' || root.child('chat').child('channels').child($channelId).child('authorizedUsers').hasChild(auth.id)) && (!root.child('suspensions').hasChild(auth.id) || root.child('suspensions').child(auth.id).val() < now))",
                          ".validate": "(newData.hasChildren(['userId','name','message','timestamp']))"
                        }
                    }
                }
            }
        },
        "users" : {
            // A list of users and their associated metadata, which can be updated by the single user or a moderator.
            "$userId": {
                ".write": "(auth != null) && (auth.id === $userId || root.child('chat').child('users').child(auth.id).child('isModerator').val() == true)",
                ".read": "(auth != null) && (auth.id === $userId || root.child('chat').child('users').child(auth.id).child('isModerator').val() == true)",
                ".validate": "($userId === newData.child('id').val())",
                "isModerator" : {
                    ".write" : "(auth != null) && auth.id === $userId && auth.chat_admin == true"
                }
            }
        },
        "presence": {
          // A mapping of active, online sessions and user ids.
          ".read": true,
          "$userId": {
            "$sessionId": {
              ".write": "(auth != null) && (!data.exists() || !newData.exists() || data.child('id').val() === auth.id)",
              "id": {
                ".validate": "(newData.val() === auth.id)" 
              },
              "name": {
                ".validate": "(newData.isString())"
              }
            }
          }
        },
        "suspensions": {
          ".write": "(auth != null) && root.child('chat').child('users').child(auth.id).child('isModerator').val() == true",
          ".read": "(auth != null) && root.child('chat').child('users').child(auth.id).child('isModerator').val() == true"
        }
    }
  }
}